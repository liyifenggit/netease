# 🎵 网易云音乐音源插件说明

## 📋 概述

**网易云音乐音源**是 Musical App 的在线音乐插件，提供海量在线音乐的搜索、播放、下载和歌词功能。
app网址：https://liyifenggit.github.io/music-player-landing/
- **音源ID**：`netease`
- **版本**：`1.0.0`
- **官网**：https://music.163.com
- **语言**：纯 ES5 JavaScript（兼容 iOS JavaScriptCore）

---

## ✨ 核心功能

### **1. 音乐搜索**
- ✅ 关键词搜索（歌曲名、歌手、专辑）
- ✅ 分页加载（每页30首）
- ✅ 实时显示搜索结果
- ✅ 支持中英文混合搜索

### **2. 在线播放**
- ✅ 多音质支持：标准（128k）、高品质（320k）、无损（FLAC）
- ✅ 智能音质降级（无损不可用时自动切换到高品质）
- ✅ URL 自动刷新（过期后重新获取）
- ✅ 实时流媒体播放

### **3. 歌词同步**
- ✅ 原文歌词（LRC 格式）
- ✅ 翻译歌词（支持中英对照）
- ✅ 逐字逐句同步显示
- ✅ 自动滚动跟随

### **4. 封面图片**
- ✅ 高清专辑封面（最高 800x800）
- ✅ 多尺寸支持（小/中/大）
- ✅ 智能回退（专辑封面 → 歌手头像）
- ✅ 自动缓存

### **5. 下载管理**
- ✅ 下载到本地音乐库
- ✅ 自动上传到 WebDAV
- ✅ 智能音质选择
- ✅ 进度监控

---

## 🔧 技术原理

### **架构设计**

```
┌─────────────────────────────────────────────┐
│           Musical App (Swift)               │
├─────────────────────────────────────────────┤
│     MusicSourceManager                      │
│     ├── JSContext (JavaScriptCore)          │
│     ├── 插件加载器                            │
│     └── API 桥接层                           │
├─────────────────────────────────────────────┤
│  netease_music_source.js (ES5)              │
│  ├── search()      搜索                      │
│  ├── getMusicUrl() 获取播放URL               │
│  ├── getLyric()    获取歌词                  │
│  └── getPicUrl()   获取封面                  │
├─────────────────────────────────────────────┤
│        网易云音乐 API                         │
│  ├── /api/search/get/web                    │
│  ├── /api/song/enhance/player/url           │
│  ├── /api/song/lyric                        │
│  └── 图片 CDN                                │
└─────────────────────────────────────────────┘
```

---

### **核心 API 说明**

#### **1. 搜索 API**
```javascript
// 端点
GET https://music.163.com/api/search/get/web

// 参数
{
    s: "周杰伦",        // 搜索关键词
    type: 1,           // 1=歌曲, 100=歌手, 10=专辑
    limit: 30,         // 每页数量
    offset: 0          // 偏移量（分页）
}

// 响应
{
    code: 200,
    result: {
        songs: [
            {
                id: 123456,
                name: "稻香",
                artists: [{name: "周杰伦"}],
                album: {
                    name: "魔杰座",
                    picUrl: "https://..."
                },
                duration: 223000  // 毫秒
            }
        ],
        songCount: 150
    }
}
```

#### **2. 播放 URL API**
```javascript
// 端点
GET https://music.163.com/api/song/enhance/player/url

// 参数
{
    ids: "[123456]",   // 歌曲ID数组
    br: 320000         // 比特率 (128000/320000/999000)
}

// 响应
{
    code: 200,
    data: [
        {
            id: 123456,
            url: "https://m7.music.126.net/...",  // 播放链接
            br: 320000,                            // 实际比特率
            size: 8912345,                         // 文件大小
            type: "mp3",                           // 格式
            expiresIn: 3600                        // 有效期（秒）
        }
    ]
}
```

#### **3. 歌词 API**
```javascript
// 端点
GET https://music.163.com/api/song/lyric

// 参数
{
    id: 123456,        // 歌曲ID
    lv: -1,            // 歌词版本
    tv: -1             // 翻译版本
}

// 响应
{
    code: 200,
    lrc: {
        lyric: "[00:00.00]原文歌词\n[00:05.00]第二句..."
    },
    tlyric: {
        lyric: "[00:00.00]翻译歌词\n[00:05.00]第二句..."
    }
}
```

---

### **音质映射**

| 音质等级 | 比特率 | 格式 | 文件大小（4分钟） |
|---------|--------|------|------------------|
| **标准** | 128 kbps | MP3 | ~4 MB |
| **高品质** | 320 kbps | MP3 | ~10 MB |
| **无损** | 999 kbps | FLAC | ~30 MB |

**智能降级逻辑**：
```
请求无损 → 失败 → 尝试高品质 → 失败 → 尝试标准 → 成功 ✅
```

---

### **封面图片处理**

**优先级顺序**：
1. `album.picUrl` - 专辑封面
2. `album.blurPicUrl` - 模糊封面
3. `artists[0].picUrl` - 歌手头像
4. 默认封面

**尺寸参数**：
```javascript
// 小图（200x200）
picUrl + "?param=200y200"

// 中图（400x400）
picUrl + "?param=400y400"

// 大图（800x800）
picUrl + "?param=800y800"
```

---

## 📱 使用方法

### **步骤 1：添加音源**

1. 打开 **Musical App**
2. 进入 **设置 → 在线音乐 → 音源管理**
3. 点击 **"添加音源"**
4. 选择 **`netease_music_source.js`** 文件
5. 等待加载完成 ✅

---

### **步骤 2：搜索音乐**

1. 进入 **在线音乐** 标签页
2. 在搜索框输入关键词（例如：`周杰伦`）
3. 点击搜索按钮
4. 浏览搜索结果

**搜索技巧**：
- ✅ 歌曲名：`稻香`
- ✅ 歌手名：`周杰伦`
- ✅ 组合搜索：`稻香 周杰伦`
- ✅ 专辑名：`魔杰座`

---

### **步骤 3：播放音乐**

**方式1：直接播放**
1. 点击歌曲行 → 立即播放
2. 自动选择最高音质
3. 后续歌曲自动加入队列

**方式2：长按菜单**
1. 长按歌曲
2. 选择 **"播放"** 或 **"添加到队列"**
3. 可选择特定音质

**音质选择**：
- **自动**：优先无损 → 高品质 → 标准
- **手动**：在设置中指定默认音质

---

### **步骤 4：下载音乐**

1. 长按歌曲
2. 选择 **"下载到本地"**
3. 自动执行：
   - ✅ 下载音频文件
   - ✅ 上传到 WebDAV 音乐库
   - ✅ 下载封面和歌词
   - ✅ 添加到本地数据库

**下载位置**：
- iOS：`Documents/Downloads/`
- WebDAV：`/音乐库/艺术家名/专辑名/歌曲.mp3`

---

### **步骤 5：推荐歌曲**

1. 播放在线音乐
2. 点击 **分享按钮 → 推荐歌曲**
3. 自动执行：
   - ✅ 下载到本地
   - ✅ 上传到 WebDAV 音乐库
   - ✅ 上传到 `recommend/` 文件夹
   - ✅ 分享给其他用户

---

## ⚙️ 配置选项

### **默认音质设置**

路径：**设置 → 在线音乐 → 默认音质**

```
- 标准（128k）   - 节省流量，快速加载
- 高品质（320k） - 推荐选择，音质好
- 无损（FLAC）   - 最佳音质，文件大
```

---

### **网络设置**

路径：**设置 → 在线音乐 → 网络**

```
- 允许蜂窝数据  - 移动网络下使用
- 仅 WiFi 播放  - 节省流量
- 自动刷新URL   - URL过期时自动重新获取
```

---

### **缓存管理**

路径：**设置 → 在线音乐 → 缓存**

```
- 缓存大小限制  - 默认 500MB
- 自动清理      - 超过限制时自动删除
- 手动清理      - 立即清空缓存
```

---

## 🎯 实战示例

### **示例1：搜索并播放周杰伦的歌**

```
1. 打开"在线音乐"
2. 搜索：周杰伦
3. 点击"稻香"
4. 开始播放 ✅
5. 后续30首歌自动排队
```

---

### **示例2：下载无损音乐**

```
1. 搜索：勇气 梁静茹
2. 长按歌曲
3. 选择"下载到本地"
4. 自动下载无损版本 ✅
5. 保存到 WebDAV 音乐库
```

---

### **示例3：推荐歌曲给朋友**

```
1. 播放在线音乐
2. 点击"分享 → 推荐歌曲"
3. 自动上传到 recommend/ ✅
4. 朋友扫描 WebDAV 后看到推荐
```

---

## 📊 功能对比

| 功能 | 网易云音乐音源 | 其他音源 |
|------|---------------|----------|
| **搜索** | ✅ 支持 | ✅ 支持 |
| **播放** | ✅ 多音质 | ⚠️ 单音质 |
| **歌词** | ✅ 原文+翻译 | ⚠️ 仅原文 |
| **封面** | ✅ 高清 | ⚠️ 低清 |
| **下载** | ✅ 支持 | ✅ 支持 |
| **推荐** | ✅ 支持 | ❌ 不支持 |
| **音质** | ✅ 128k/320k/无损 | ⚠️ 128k |
| **稳定性** | ✅ 官方API | ⚠️ 第三方 |

---

## ⚠️ 注意事项

### **版权限制**
- ⚠️ 部分歌曲可能无版权，无法播放
- ⚠️ 地区限制（部分歌曲仅限中国大陆）
- ✅ 插件会自动跳过无版权歌曲

### **网络要求**
- ✅ 需要稳定的网络连接
- ⚠️ 移动网络下建议使用标准音质
- ✅ WiFi 环境下可使用无损音质

### **URL 有效期**
- ⚠️ 播放链接有效期 1 小时
- ✅ 过期后自动刷新
- ✅ 无需手动操作

### **性能优化**
- ✅ 封面自动缓存
- ✅ 搜索结果分页加载
- ✅ 内存占用优化

---

## 🔍 故障排除

### **1. 搜索失败**

**症状**：搜索后无结果或报错

**解决方案**：
```
✅ 检查网络连接
✅ 更换搜索关键词
✅ 重启 App
✅ 查看日志（设置 → 关于 → 日志）
```

---

### **2. 播放失败**

**症状**：点击播放后无声音

**原因 & 解决**：
| 原因 | 解决方案 |
|------|----------|
| 无版权 | 更换其他版本或音源 |
| 网络问题 | 检查 WiFi/蜂窝数据 |
| URL 过期 | 自动重试，等待刷新 |
| 音质不可用 | 降级到标准音质 |

---

### **3. 下载失败**

**症状**：下载进度卡住或报错

**解决方案**：
```
✅ 检查 WebDAV 配置
✅ 确保存储空间充足
✅ 检查网络稳定性
✅ 重试下载
```

---

### **4. 封面缺失**

**症状**：歌曲显示无封面

**解决方案**：
```
✅ 正常现象（部分歌曲无封面）
✅ 会自动使用歌手头像
✅ 可手动从网易云复制封面 URL
```

---

## 📈 性能指标

| 指标 | 数值 | 说明 |
|------|------|------|
| **搜索速度** | < 1秒 | 平均响应时间 |
| **播放延迟** | < 2秒 | 点击到播放 |
| **下载速度** | 取决于网络 | 通常 2-5 MB/s |
| **内存占用** | < 50 MB | JavaScript 引擎 |
| **CPU 占用** | < 5% | 解析和播放 |

---

## 🚀 未来规划

### **即将推出**
- 🔲 榜单功能（热歌榜、新歌榜）
- 🔲 歌手详情页
- 🔲 专辑浏览
- 🔲 评论查看
- 🔲 电台播放

### **长期目标**
- 🔲 MV 播放
- 🔲 用户歌单导入
- 🔲 智能推荐算法
- 🔲 社交分享
- 🔲 云端同步

---

## 📝 更新日志

### **v1.0.0** (当前版本)
- ✅ 基础搜索功能
- ✅ 多音质播放
- ✅ 歌词同步
- ✅ 封面加载
- ✅ 下载管理
- ✅ 推荐功能

---

## 💡 开发者信息

### **技术栈**
- **语言**：JavaScript (ES5)
- **运行环境**：iOS JavaScriptCore
- **API**：网易云音乐官方 API
- **架构**：插件化设计

### **核心函数**
```javascript
search(keyword, page, type)      // 搜索
getMusicUrl(songInfo, quality)   // 获取播放URL
getLyric(songInfo)               // 获取歌词
getPicUrl(songInfo, size)        // 获取封面
```

### **调试方法**
```javascript
// 控制台输出
console.log('调试信息');

// 查看网络请求
httpRequest(url, options).then(response => {
    console.log(response.body);
});
```

---

## 🤝 贡献

欢迎提交问题和改进建议！

- **问题反馈**：GitHub Issues
- **功能建议**：GitHub Discussions
- **代码贡献**：Pull Requests

---

## 📄 许可证

本音源插件仅供学习和个人使用，请遵守网易云音乐的服务条款。

---

## 🎉 总结

**网易云音乐音源**为 Musical App 提供了强大的在线音乐功能，支持搜索、播放、下载、歌词、封面等完整功能，是您享受海量音乐的最佳选择！

**开始使用吧！🎵**
