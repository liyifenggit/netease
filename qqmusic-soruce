// QQéŸ³ä¹éŸ³æº - iOS JavaScriptCore å…¼å®¹ç‰ˆæœ¬
// çº¯ ES5 è¯­æ³•ï¼Œä¸ä½¿ç”¨è§£æ„èµ‹å€¼å’Œæ··æ·†ä»£ç 

// éŸ³æºä¿¡æ¯
var sourceInfo = {
    id: 'qqmusic',
    name: 'QQéŸ³ä¹',
    version: '1.0.0',
    author: 'Musical App',
    description: 'QQéŸ³ä¹åœ¨çº¿éŸ³æºï¼Œæ”¯æŒæœç´¢ã€æ’­æ”¾ã€æ­Œè¯',
    homepage: 'https://y.qq.com',
    supportedTypes: ['song'],
    supportedQualities: ['standard', 'high', 'lossless']
};

// API åŸºç¡€é…ç½® - ä½¿ç”¨æ›´ç¨³å®šçš„åŸŸå
var API_BASE = 'https://u.y.qq.com/cgi-bin/musicu.fcg';
var API_BASE_BACKUP = 'https://c.y.qq.com/soso/fcgi-bin/client_search_cp'; // å¤‡ç”¨æœç´¢API
var API_CDN = 'https://ws.stream.qqmusic.qq.com';
var API_CDN_BACKUP = 'https://isure.stream.qqmusic.qq.com'; // å¤‡ç”¨CDN
var API_LYRIC = 'https://c.y.qq.com/lyric/fcgi-bin/fcg_query_lyric_new.fcg';

// é€šç”¨è¯·æ±‚å¤´
var COMMON_HEADERS = {
    'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Mobile/15E148 QQ/8.8.0',
    'Referer': 'https://y.qq.com',
    'Origin': 'https://y.qq.com',
    'Accept': 'application/json, text/plain, */*',
    'Accept-Language': 'zh-CN,zh;q=0.9',
    'Accept-Encoding': 'gzip, deflate, br'
};

// è·å–ç”¨æˆ·Cookieï¼ˆå¦‚æœå·²ç™»å½•ï¼‰
function getQQCookieIfAvailable() {
    try {
        if (typeof getQQCookie === 'function') {
            var cookie = getQQCookie();
            if (cookie && cookie.length > 0) {
                console.log('ğŸª [QQéŸ³ä¹] ä½¿ç”¨ç™»å½•Cookie');
                return cookie;
            }
        }
    } catch (error) {
        console.log('âš ï¸ [QQéŸ³ä¹] è·å–Cookieå¤±è´¥: ' + error.message);
    }
    return '';
}

// æ„å»ºè¯·æ±‚å¤´ï¼ˆåŒ…å«Cookieï¼‰
function buildHeaders() {
    var headers = {};
    // å¤åˆ¶é€šç”¨è¯·æ±‚å¤´
    for (var key in COMMON_HEADERS) {
        headers[key] = COMMON_HEADERS[key];
    }
    // å¦‚æœæœ‰Cookieï¼Œæ·»åŠ åˆ°è¯·æ±‚å¤´
    var cookie = getQQCookieIfAvailable();
    if (cookie) {
        headers['Cookie'] = cookie;
    }
    return headers;
}

// æœç´¢éŸ³ä¹
function search(keyword, page, type) {
    return new Promise(function(resolve, reject) {
        var limit = 50; // å¢åŠ åˆ°50é¦–ï¼Œæä¾›æ›´å¤šæœç´¢ç»“æœ
        var offset = (page - 1) * limit;
        
        // æ„å»ºQQéŸ³ä¹æœç´¢è¯·æ±‚ä½“
        var reqBody = {
            comm: {
                ct: '19',
                cv: '1859',
                uin: '0'
            },
            music: {
                method: 'DoSearchForQQMusicDesktop',
                module: 'music.search.SearchCgiService',
                param: {
                    num_per_page: limit,
                    page_num: page,
                    query: keyword,
                    search_type: 0
                }
            }
        };
        
        var url = API_BASE + '?data=' + encodeURIComponent(JSON.stringify(reqBody));
        
        httpRequest(url, {
            method: 'GET',
            headers: buildHeaders(), // åŒ…å«Cookie
            timeout: 10000 // 10ç§’è¶…æ—¶
        }).then(function(response) {
            try {
                var data = JSON.parse(response.body);
                
                if (data.code !== 0 || !data.music || !data.music.data) {
                    reject(new Error('æœç´¢å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯')));
                    return;
                }
                
                var result = data.music.data;
                var body = result.body;
                
                if (!body || !body.song || !body.song.list) {
                    resolve({
                        list: [],
                        total: 0,
                        page: page,
                        hasMore: false
                    });
                    return;
                }
                
                // è½¬æ¢æ­Œæ›²åˆ—è¡¨
                var songs = body.song.list.map(function(song) {
                    // è·å–æ­Œæ‰‹å
                    var artists = song.singer || [];
                    var artistNames = artists.map(function(ar) {
                        return ar.name;
                    });
                    var artist = artistNames.join(' / ') || 'æœªçŸ¥æ­Œæ‰‹';
                    
                    // è·å–ä¸“è¾‘å
                    var album = (song.album && song.album.name) || 'æœªçŸ¥ä¸“è¾‘';
                    
                    // è·å–å°é¢
                    var picUrl = '';
                    if (song.album && song.album.mid) {
                        var albumMid = song.album.mid;
                        picUrl = 'https://y.gtimg.cn/music/photo_new/T002R300x300M000' + albumMid + '.jpg';
                    }
                    
                    if (!picUrl && artists.length > 0 && artists[0].mid) {
                        var singerMid = artists[0].mid;
                        picUrl = 'https://y.gtimg.cn/music/photo_new/T001R300x300M000' + singerMid + '.jpg';
                    }
                    
                    var duration = song.interval || 0;
                    
                    // è·å–æ­Œæ›²midï¼ˆæœ€é‡è¦çš„å­—æ®µï¼‰
                    var songMid = song.mid || song.songmid || '';
                    
                    // è°ƒè¯•æ—¥å¿—
                    if (picUrl) {
                        console.log('âœ… å°é¢: ' + song.name + ' -> ' + picUrl);
                    } else {
                        console.log('âš ï¸ æ— å°é¢: ' + song.name);
                    }
                    
                    // æ£€æŸ¥midæ˜¯å¦å­˜åœ¨
                    if (!songMid) {
                        console.log('âš ï¸ [QQéŸ³ä¹] æ­Œæ›²ç¼ºå°‘mid: ' + song.name + ', id=' + song.id);
                    }
                    
                    return {
                        id: String(song.id),
                        name: song.name || song.title || 'æœªçŸ¥æ­Œæ›²',
                        artist: artist,
                        album: album,
                        duration: duration,
                        picUrl: picUrl,
                        metadata: {
                            mid: songMid,
                            albumMid: (song.album && song.album.mid) || '',
                            mediaId: song.file ? song.file.media_mid : '',
                            // ä¿å­˜åŸå§‹songå¯¹è±¡çš„å…³é”®å­—æ®µç”¨äºè°ƒè¯•
                            songId: song.id || '',
                            songName: song.name || ''
                        }
                    };
                });
                
                var total = body.song.total || songs.length;
                var hasMore = (offset + songs.length) < total;
                
                resolve({
                    list: songs,
                    total: total,
                    page: page,
                    hasMore: hasMore
                });
                
            } catch (error) {
                reject(new Error('è§£ææœç´¢ç»“æœå¤±è´¥: ' + error.message));
            }
        }).catch(function(error) {
            // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            var errorMsg = 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯DNSé”™è¯¯
            if (error.message.indexOf('hostname') > -1 || error.message.indexOf('DNS') > -1 || error.message.indexOf('åŸŸå') > -1 || error.message.indexOf('host') > -1) {
                errorMsg = 'DNSè§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•ã€‚å¯èƒ½åŸå› ï¼š1) ç½‘ç»œè¿æ¥é—®é¢˜ 2) APIåŸŸåé™åˆ¶è®¿é—® 3) éœ€è¦ç‰¹æ®Šç½‘ç»œç¯å¢ƒ';
                console.log('âš ï¸ QQéŸ³ä¹DNSè§£æå¤±è´¥');
                console.log('å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ‡æ¢ç½‘ç»œï¼ˆWiFi/ç§»åŠ¨æ•°æ®ï¼‰');
            }
            
            reject(new Error(errorMsg));
        });
    });
}

// è¾…åŠ©å‡½æ•°ï¼šé€šè¿‡æ­Œæ›²IDè·å–è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬midï¼‰
function getSongDetailById(songId) {
    return new Promise(function(resolve, reject) {
        var reqBody = {
            comm: { ct: '24', cv: '0', uin: '0' },
            req_0: {
                module: 'music.trackInfo.UniformRuleCtrl',
                method: 'CgiGetTrackInfo',
                param: {
                    ids: [parseInt(songId)],
                    types: [0]
                }
            }
        };
        
        var url = API_BASE + '?data=' + encodeURIComponent(JSON.stringify(reqBody));
        
        httpRequest(url, {
            method: 'GET',
            headers: COMMON_HEADERS,
            timeout: 10000
        }).then(function(response) {
            try {
                var data = JSON.parse(response.body);
                if (data.code === 0 && data.req_0 && data.req_0.data && data.req_0.data.tracks && data.req_0.data.tracks.length > 0) {
                    var track = data.req_0.data.tracks[0];
                    resolve(track.mid || '');
                } else {
                    resolve('');
                }
            } catch (e) {
                resolve('');
            }
        }).catch(function() {
            resolve('');
        });
    });
}

// è·å–æ’­æ”¾ URL
function getMusicUrl(songInfo, quality) {
    return new Promise(function(resolve, reject) {
        // è¯¦ç»†çš„å‚æ•°æ£€æŸ¥å’Œæ—¥å¿—
        console.log('ğŸ” [QQéŸ³ä¹] getMusicUrl å‚æ•°:');
        console.log('   - songInfo.id: ' + (songInfo.id || 'æ— '));
        console.log('   - songInfo.name: ' + (songInfo.name || 'æ— '));
        console.log('   - songInfo.metadata: ' + (songInfo.metadata ? 'æœ‰' : 'æ— '));
        
        if (!songInfo.metadata) {
            console.log('âŒ [QQéŸ³ä¹] metadataç¼ºå¤±');
            reject(new Error('æ­Œæ›²å…ƒæ•°æ®ç¼ºå¤±'));
            return;
        }
        
        var songMid = songInfo.metadata.mid || '';
        console.log('   - metadata.mid: ' + (songMid || 'ç©º'));
        
        if (!songMid) {
            // å°è¯•é€šè¿‡æ­Œæ›²IDè·å–mid
            console.log('ğŸ”„ [QQéŸ³ä¹] midä¸ºç©ºï¼Œå°è¯•é€šè¿‡æ­Œæ›²è¯¦æƒ…APIè·å–...');
            
            getSongDetailById(songInfo.id).then(function(mid) {
                if (mid) {
                    console.log('âœ… [QQéŸ³ä¹] æˆåŠŸè·å–mid: ' + mid);
                    // æ›´æ–°songInfoä¸­çš„mid
                    songInfo.metadata.mid = mid;
                    // é€’å½’è°ƒç”¨è‡ªå·±ï¼Œè¿™æ¬¡åº”è¯¥æœ‰midäº†
                    getMusicUrl(songInfo, quality).then(resolve).catch(reject);
                } else {
                    console.log('âŒ [QQéŸ³ä¹] è¯¦æƒ…APIä¹Ÿæ— æ³•è·å–mid');
                    console.log('   å¯ç”¨å­—æ®µ: ' + JSON.stringify(songInfo.metadata).substring(0, 200));
                    reject(new Error('æ­Œæ›²IDæ— æ•ˆï¼ˆmidä¸ºç©ºï¼‰ï¼Œå»ºè®®å°è¯•å…¶ä»–éŸ³ä¹æº'));
                }
            }).catch(function(error) {
                console.log('âŒ [QQéŸ³ä¹] è·å–è¯¦æƒ…å¤±è´¥: ' + error.message);
                reject(new Error('æ­Œæ›²IDæ— æ•ˆï¼ˆmidä¸ºç©ºï¼‰'));
            });
            return;
        }
        
        // QQéŸ³ä¹æ–‡ä»¶ç±»å‹æ˜ å°„ï¼ˆä½¿ç”¨C400æ ¼å¼ï¼Œå…¼å®¹æ€§æ›´å¥½ï¼‰
        var fileType = 'C400'; // é»˜è®¤ä½¿ç”¨C400 (m4aæ ¼å¼)
        var fileExt = '.m4a';
        
        if (quality === 'lossless') {
            fileType = 'F000';
            fileExt = '.flac';
        } else if (quality === 'high') {
            fileType = 'M800';
            fileExt = '.mp3';
        }
        
        var guid = generateGuid();
        var filename = fileType + songMid + fileExt;
        
        var reqBody = {
            comm: { 
                ct: '24', 
                cv: '0',
                uin: '0'
            },
            req_0: {
                module: 'vkey.GetVkeyServer',
                method: 'CgiGetVkey',
                param: {
                    guid: guid,
                    songmid: [songMid],
                    songtype: [0],
                    uin: '0',
                    loginflag: 1,
                    platform: '20',
                    filename: [filename]
                }
            }
        };
        
        var url = API_BASE + '?data=' + encodeURIComponent(JSON.stringify(reqBody));
        
        httpRequest(url, {
            method: 'GET',
            headers: buildHeaders(), // åŒ…å«Cookie
            timeout: 10000 // 10ç§’è¶…æ—¶
        }).then(function(response) {
            try {
                var data = JSON.parse(response.body);
                
                // è°ƒè¯•æ—¥å¿—
                console.log('ğŸ” [QQéŸ³ä¹] vkeyå“åº” code: ' + data.code);
                
                if (data.code !== 0 || !data.req_0 || !data.req_0.data) {
                    console.log('âŒ [QQéŸ³ä¹] vkeyè·å–å¤±è´¥ï¼Œå“åº”: ' + JSON.stringify(data).substring(0, 200));
                    reject(new Error('è·å–æ’­æ”¾é“¾æ¥å¤±è´¥'));
                    return;
                }
                
                var vkeyData = data.req_0.data;
                
                if (!vkeyData.midurlinfo || vkeyData.midurlinfo.length === 0) {
                    console.log('âš ï¸ [QQéŸ³ä¹] midurlinfoä¸ºç©º');
                    reject(new Error('è¯¥æ­Œæ›²æš‚æ— ç‰ˆæƒæˆ–æ— æ³•æ’­æ”¾'));
                    return;
                }
                
                var midUrlInfo = vkeyData.midurlinfo[0];
                console.log('ğŸ” [QQéŸ³ä¹] purl: ' + (midUrlInfo.purl || 'ç©º'));
                console.log('ğŸ” [QQéŸ³ä¹] errtype: ' + (midUrlInfo.errtype || 'æ— '));
                
                if (!midUrlInfo.purl) {
                    // æ£€æŸ¥å…·ä½“çš„é”™è¯¯ç±»å‹
                    if (midUrlInfo.errtype) {
                        console.log('âŒ [QQéŸ³ä¹] é”™è¯¯ç±»å‹: ' + midUrlInfo.errtype);
                    }
                    reject(new Error('è¯¥æ­Œæ›²æš‚æ— ç‰ˆæƒæˆ–æ— æ³•æ’­æ”¾'));
                    return;
                }
                
                var sip = vkeyData.sip && vkeyData.sip.length > 0 ? vkeyData.sip[0] : API_CDN;
                var playUrl = sip + midUrlInfo.purl;
                
                // iOS ATSè¦æ±‚ä½¿ç”¨HTTPSï¼Œå¼ºåˆ¶è½¬æ¢HTTPä¸ºHTTPS
                if (playUrl.indexOf('http://') === 0) {
                    playUrl = playUrl.replace('http://', 'https://');
                    console.log('ğŸ”’ [QQéŸ³ä¹] å·²å°†HTTPè½¬æ¢ä¸ºHTTPSä»¥ç¬¦åˆATSè¦æ±‚');
                }
                
                console.log('ğŸ”— [QQéŸ³ä¹] æœ€ç»ˆæ’­æ”¾URL: ' + playUrl.substring(0, 100) + '...');
                
                // æ ¹æ®å®é™…æ–‡ä»¶ç±»å‹åˆ¤æ–­æ ¼å¼å’ŒéŸ³è´¨
                var actualQuality = quality;
                var format = 'mp3';
                var br = 128000;
                
                if (fileType === 'F000') {
                    format = 'flac';
                    br = 999000;
                    actualQuality = 'lossless';
                } else if (fileType === 'M800') {
                    format = 'mp3';
                    br = 320000;
                    actualQuality = 'high';
                } else if (fileType === 'C400') {
                    format = 'm4a';
                    br = 128000;
                    actualQuality = 'standard';
                } else if (fileType === 'M500') {
                    format = 'mp3';
                    br = 128000;
                    actualQuality = 'standard';
                }
                
                console.log('âœ… [QQéŸ³ä¹] æ’­æ”¾URLè·å–æˆåŠŸï¼Œæ ¼å¼: ' + format + ', éŸ³è´¨: ' + actualQuality);
                
                resolve({
                    url: playUrl,
                    quality: actualQuality,
                    format: format,
                    size: 0,
                    br: br,
                    expiresIn: 3600
                });
                
            } catch (error) {
                reject(new Error('è§£ææ’­æ”¾é“¾æ¥å¤±è´¥: ' + error.message));
            }
        }).catch(function(error) {
            reject(new Error('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message));
        });
    });
}

// è·å–æ­Œè¯
function getLyric(songInfo) {
    return new Promise(function(resolve, reject) {
        var songMid = songInfo.metadata.mid || '';
        
        var url = API_LYRIC + '?songmid=' + songMid + '&g_tk=5381&loginUin=0&hostUin=0&format=json&inCharset=utf8&outCharset=utf-8&notice=0&platform=yqq&needNewCode=0';
        
        httpRequest(url, {
            method: 'GET',
            headers: buildHeaders(), // åŒ…å«Cookie
            timeout: 10000 // 10ç§’è¶…æ—¶
        }).then(function(response) {
            try {
                var data = JSON.parse(response.body);
                
                if (data.retcode !== 0) {
                    resolve({ lyric: '[00:00.00]æš‚æ— æ­Œè¯', translatedLyric: null });
                    return;
                }
                
                var lyric = data.lyric ? decodeBase64(data.lyric) : '[00:00.00]æš‚æ— æ­Œè¯';
                var trans = data.trans ? decodeBase64(data.trans) : null;
                
                resolve({
                    lyric: lyric,
                    translatedLyric: trans
                });
                
            } catch (error) {
                resolve({ lyric: '[00:00.00]æš‚æ— æ­Œè¯', translatedLyric: null });
            }
        }).catch(function() {
            resolve({ lyric: '[00:00.00]æš‚æ— æ­Œè¯', translatedLyric: null });
        });
    });
}

// è·å–å°é¢ URL
function getPicUrl(songInfo, size) {
    return new Promise(function(resolve) {
        var picUrl = songInfo.picUrl || '';
        
        if (!picUrl) {
            resolve('');
            return;
        }
        
        var sizeParam = '300x300';
        if (size === 'small') {
            sizeParam = '150x150';
        } else if (size === 'medium') {
            sizeParam = '500x500';
        } else if (size === 'large') {
            sizeParam = '800x800';
        }
        
        picUrl = picUrl.replace(/R\d+x\d+M/, 'R' + sizeParam + 'M');
        
        resolve(picUrl);
    });
}

// è¾…åŠ©å‡½æ•°
function generateGuid() {
    var result = '';
    for (var i = 0; i < 32; i++) {
        result += Math.floor(Math.random() * 16).toString(16);
    }
    return result;
}

function decodeBase64(str) {
    try {
        if (typeof atob !== 'undefined') {
            return atob(str);
        }
        return str;
    } catch (e) {
        return str;
    }
}

console.log('âœ… QQéŸ³ä¹éŸ³æºåŠ è½½æˆåŠŸï¼');
